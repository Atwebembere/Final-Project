---
title: "Advanced Data Analysis Final Project"
author: "Raymond Atwebembere"
date: ""
output:
  html_document: default
  df_print: paged
---

# Systems date:

`r format(Sys.Date(), '%B %d, %Y')` 

### Is there a relationship between sex and risk of cigarette smoking among nonsmoking participants between 13 and 15 years of age during the 2018 data collection period? A secondary analysis of the Global Youth Tobacco Survey conducted in Uganda.

### 1. Data Management

#### 1a. Installing packages and loading dataset:

```{r}
## Installing havena and tidyverse packages and libraries:
pacman::p_load(haven,readr, tidyverse, naniar, VIM, mice, lattice, table1, DiagrammeR, rsvg, dplyr, car, lmtest, mitml)

##Loading dataset

Tobacco <- read_csv('UGANDA_DATA_18.csv')

##Subsetting dataset to use variables of interest

Tobacco_data <-Tobacco %>%
  dplyr::select(CR1, CR2, UGR3, UGR4, CR5, CR9, CR30, CR39, CR40, OR45, OR46, CR34)
colnames(Tobacco_data)

##Renaming columns
names(Tobacco_data)[1:12] <- c(
  "Age", "Sex", "Class", "Allowance", 
  "Smokingstatuscigarettes", "Smokingtobaccoother", 
  "Seenantismokingad", "Riskoftobaccouse1", "Riskoftobaccouse2", 
  "Parentwhosmoke", "Friendwhosmokes", "Seenprosmokingcontent"
)
colnames(Tobacco_data)

##Understanding the type of variables in the dataset
sapply(Tobacco_data, typeof)

```

### 2. Subsetting dataset

#### 2a. Exclude participants that reported yes to smoking.

```{r}

#Filtering data to exclude participants that reported yes to smoking any tobacco product

# Filter out participants who smoke cigarettes or other tobacco products and remove missing values
Tobacco_data1 <- Tobacco_data %>%
  filter(Smokingstatuscigarettes == 2 & Smokingtobaccoother == 2 & 
         !is.na(Smokingstatuscigarettes) & !is.na(Smokingtobaccoother)) 

# Calculate the number of excluded rows
ex1 <- nrow(Tobacco_data) - nrow(Tobacco_data1)

# Output the number of excluded rows
ex1 

# Verify the remaining dataset
table(Tobacco_data1$Smokingstatuscigarettes, Tobacco_data1$Smokingtobaccoother)

```

#### 2b. Exclude participants that are below 12 years

```{r}
# Filter the data to include only participants aged 13 to 15 years
Tobacco_data2 <- Tobacco_data1 %>%
  filter(Age %in% c(3, 4, 5))

# Calculate the number of excluded observations

ex2 <- nrow(Tobacco_data1) - nrow(Tobacco_data2)

ex2 # Output the number of excluded rows

table (Tobacco_data2$Age)

```

#### 2c. Exclude participants with missing data on "Risk of tobacco use 1 and Risk of tobacco use 2"

```{r}

# Exclude participants with missing data on both 'Risk of tobacco use 1' and 'Risk of tobacco use 2'
Tobacco_data3 <- Tobacco_data2 %>%
  filter(!is.na(Riskoftobaccouse1) & !is.na(Riskoftobaccouse2))

# Calculate how many participants were excluded
ex3 <- nrow(Tobacco_data2) - nrow(Tobacco_data3)

ex3 # Output the number of excluded rows

#Ensuring all Na's from risk of tobacco use are eliminated

sum(is.na(Tobacco_data3$Riskoftobaccouse1))
sum(is.na(Tobacco_data3$Riskoftobaccouse2))

##Subsetting dataset to use variables of interest

Tobacco_data4 <-Tobacco_data3 %>%
  dplyr::select("Age", "Sex", "Riskoftobaccouse1", "Riskoftobaccouse2", "Class", "Allowance", "Friendwhosmokes", "Seenantismokingad", "Seenprosmokingcontent", "Parentwhosmoke")
colnames(Tobacco_data2)

```

### 3. Figure 1:

```{r}

figure1 <- grViz(diagram = "digraph flowchart{ # gives beginning of flowchart

      # node definitions with substituted label text
      
      node [fontname = Helvetica, shape = rectangle, fontsize=10] 
      
      # Define the nodes: nodes indicate how many boxes you will have in your diagram. Since I have three sets of exclusions, I will have four nodes.
      
      node1 [label = '@@1'] # starting number
      node2 [label = '@@2'] # number after exclusion 1
      node3 [label = '@@3'] # number after exclusion 2
      node4 [label = '@@4'] # number after exclusion 3
      
      # edge definitions with the node IDs are used to indicate how the rectangle boxes flow from each other. 
      
      node1 -> node2 -> node3 -> node4
}
      # This set of code provides the text in each rectangle box.
      [1]: 'Records received from GYTSAFRO2018 Uganda All Schools n = 3,458'
      [2]: 'Excluding 927 participants that reported yes to smoking n = 2,531'
      [3]: 'Excluding 978 participants that are below 13 years and above 15 years n = 1,553'
      [4]: 'Excluding 26 participants with missing data on `Risk of tobacco use 1 and Risk of tobacco use 2` n = 1,527'
      ")
figure1

# exporting figure

figure1 %>%
  DiagrammeRsvg::export_svg() %>% 
  charToRaw() %>% 
  rsvg::rsvg_pdf("Figure 1.pdf")

```

### 4. Relabling variable responses using the numeric and factor funtions:

```{r}

# Sex - change it to numeric, set female as reference
Tobacco_data4 <- Tobacco_data4 %>% 
  mutate(Sex = case_when(Sex== "2" ~ 0,
                             Sex== "1" ~ 1
                             ))
Tobacco_data4$Sex <- factor(Tobacco_data4$Sex, levels = c(0:1), labels = c("F", "M")) # make it a factor and give factor labels of F for female and M for male

# Recode 'Age' into 0, 1, 2 using case_when
Tobacco_data4 <- Tobacco_data4 %>%
  mutate(
    Age = case_when(
      Age == 3 ~ 0,  # 13 years old
      Age == 4 ~ 1,  # 14 years old
      Age == 5 ~ 2   # 15 years old
    ))

# Convert 'Age' to a factor with labels
Tobacco_data4$Age <- factor(
  Tobacco_data4$Age,
  levels = c(2, 1, 0),
  labels = c("15 years", "13 years", "14 years")) # make it a factor and give factor labels

# Riskoftobaccouse1 - change it to numeric. Collapse categories set "No" as reference
Tobacco_data4 <- Tobacco_data4 %>%
  mutate(Riskoftobaccouse1 = case_when(
    Riskoftobaccouse1 %in% c("1", "2") ~ 0,  # "Definitely not" and "Probably not" become 0
    Riskoftobaccouse1 %in% c("3", "4") ~ 1   # "Probably yes" and "Definitely yes" become 1
  ))
 # Convert to factor with labels "No" and "Yes"
Tobacco_data4$Riskoftobaccouse1 <- factor(Tobacco_data4$Riskoftobaccouse1,
                                          levels = c(0, 1),
                                          labels = c("No", "Yes"))

# Riskoftobaccouse2 - change it to numeric. Collapse categories set "No" as reference
Tobacco_data4 <- Tobacco_data4 %>%
  mutate(Riskoftobaccouse2 = case_when(
    Riskoftobaccouse2 %in% c("1", "2") ~ 0,  # "Definitely not" and "Probably not" become 0
    Riskoftobaccouse2 %in% c("3", "4") ~ 1   # "Probably yes" and "Definitely yes" become 1
  ))
 # Convert to factor with labels "No" and "Yes"
Tobacco_data4$Riskoftobaccouse2 <- factor(Tobacco_data4$Riskoftobaccouse2,
                                          levels = c(0, 1),
                                          labels = c("No", "Yes"))

# Parentwhosmoke - change it to numeric. Collapse categories set "No" as reference

Tobacco_data4 <- Tobacco_data4 %>%
  mutate(Parentwhosmoke = case_when(
    Parentwhosmoke %in% c("1", "5") ~ 0,  # "None" and "I don't know" become 0
    Parentwhosmoke %in% c("2", "3", "4") ~ 1   # "Both", "Father only", and "Mother only" become 1
  ))
 # Convert to factor with labels "No" and "Yes"
Tobacco_data4$Parentwhosmoke <- factor(Tobacco_data4$Parentwhosmoke,
                                          levels = c(0, 1),
                                          labels = c("No", "Yes"))

#   Class - change it to numeric, set "Primary 7" as reference
Tobacco_data4 <- Tobacco_data4 %>%
  mutate(Class = case_when(Class=="4" ~ 0,
                              Class=="1" ~ 1,
                              Class=="2" ~ 2,
                              Class=="3" ~ 3
                              )) 
Tobacco_data4$Class <- factor(Tobacco_data4$Class, levels = c(0:3), labels = c("Senior 3", "Primary 7", "Senior 1", "Senior 2")) # make it a factor and give factor labels for Class

# Allowance - change it to numeric, set "Usually don't have any spending money" as reference
Tobacco_data4 <- Tobacco_data4 %>%
  mutate(Allowance = case_when(
    Allowance == "7" ~ 0,
    Allowance %in% c("1", "2") ~ 1,
    Allowance %in% c("3", "4") ~ 2,
    Allowance %in% c("5", "6") ~ 3
  ))

# Convert Allowance to a factor with the specified reference level
Tobacco_data4$Allowance <- factor(Tobacco_data4$Allowance, 
                                  levels = c(0, 1, 2, 3), 
                                  labels = c("Ushs.50,001 and above", 
                                             "Less than Ushs.2,000", 
                                             "Ushs.2,000-10,000", 
                                             "Ushs 10,001-50,000"))

# Convert Friendwhosmokes to a factor with the specified reference level
Tobacco_data4 <- Tobacco_data4 %>%
  mutate(Friendwhosmokes = case_when(
      Friendwhosmokes == "1" ~ 0,
      Friendwhosmokes %in% c("2", "3", "4") ~ 1))

# Convert to factor with levels 0 and 1 labeled as "No" and "Yes"
Tobacco_data4$Friendwhosmokes <- factor(Tobacco_data4$Friendwhosmokes, levels = c(0, 1), labels = c("No", "Yes"))

# Seensmokingadvertisement - change it to numeric, set "No" as reference
Tobacco_data4 <- Tobacco_data4 %>% 
  mutate(Seenantismokingad = case_when(Seenantismokingad== "2" ~ 0,
                             Seenantismokingad== "1" ~ 1
                             ))
Tobacco_data4$Seenantismokingad <- factor(Tobacco_data4$Seenantismokingad, levels = c(0:1), labels = c("No", "Yes")) # make it a factor and give it factor labels.

# Seenprosmokingcontent - change it to numeric, set "No" as reference
Tobacco_data4 <- Tobacco_data4 %>% 
  mutate(Seenprosmokingcontent = case_when(Seenprosmokingcontent== "2" ~ 0,
                             Seenprosmokingcontent== "1" ~ 1
                             ))
Tobacco_data4$Seenprosmokingcontent <- factor(Tobacco_data4$Seenprosmokingcontent, levels = c(0:1), labels = c("No", "Yes")) # make it a factor and give it factor labels.

head(Tobacco_data4)

```

### 5. Imputing for missing data

```{r}
Tobacco_data4 # a dataset from GYTS of 1,527 observations containing "Age", "Sex", "Riskoftobaccouse1", "Riskoftobaccouse2", "Class", "Allowance", "Friendwhosmokes", "Seenantismokingad" ,"Seenprosmokingcontent", "Parentwhosmoke", 
View(Tobacco_data4)
summary(Tobacco_data4)
```

#### 5a. Look at missing data patterns using the md.pattern function

```{r}
md.pattern(Tobacco_data4, rotate.names=TRUE)
# blue = not missing, red = missing
# The numbers in the left column are the number of observations with each pattern
# The numbers in the right column are the numbers of variables missing for that pattern
# The number in the bottom row is the number of observations with missing values for the variable indicated in the top row
# The number in the bottom right corner is the total number of missing values in the dataset
# 1297/1297 rows (i.e., observations) are complete, as indicated by all blue cells in the first row
# 367/1297 rows have missing data on Seenprosmokingcontent
# 323/1297 rows have missing data on Seenantismokingad
# 27/1297 rows have missing data on Class
# 5/1297 rows have missing data on Sex
# 5/1297 rows have missing data on Allowance
# 3/1297 rows have missing data on Friendwhosmokes
# There are a total of 11 missing data patterns in the dataset
# Analytic Dataframe
```

#### 5b. We can also look at missing data for pairs of variables using the md.pairs function in the MICE package, which could inform correlations between variables in missingness

-   Four patterns are present

    -   rr: values for both variables are present and accounted for (rr = response-response)
    -   rm: values for the first variable are available and the second variable are missing (rm = response-missing)
    -   mr: values for the first variable are missing and the second variable is available (mr = missing-response)
    -   mm: values for both variables are missing (mm = missing-missing)

    ```{r}
    md.pairs(Tobacco_data4)

     # rr (Response-Response)
    # The rr matrix records cases where both variables have values present:

    # Row 1 (Age):

    # 1,522 observations have values for both Age and Sex.
    # 1,527 observations have values for both Age and Riskoftobaccouse1.
    # 1,527 observations have values for both Age and Riskoftobaccouse2.
    # 1,518 observations have values for both Age and Class.
    # 1,523 observations have values for both Age and Allowance.
    # 1,524 observations have values for both Age and Friendwhosmokes.
    # 1,503 observations have values for both Age and Seenantismokingad.
    # 1,224 observations have values for both Age and Seenprosmokingcontent.
    # 1,525 observations have values for both Age and Parentwhosmoke.

    # Row 2 (Sex):
      
    # 1,527 observations have values for both Sex and Riskoftobaccouse1.
    # 1,527 observations have values for both Sex and Riskoftobaccouse2.
    # 1,518 observations have values for both Sex and Class.
    # 1,523 observations have values for both Sex and Allowance.
    # 1,519 observations have values for both Sex and Friendwhosmokes.
    # 1,503 observations have values for both Sex and Seenantismokingad.
    # 1,224 observations have values for both Sex and Seenprosmokingcontent.
    # 1,520 observations have values for both Sex and Parentwhosmoke.

    # Row 3 (Parentwhosmoke):

    # 1,525 observations have values for both Parentwhosmoke and Riskoftobaccouse1.
    # 1,525 observations have values for both Parentwhosmoke and Riskoftobaccouse2.
    # 1,520 observations have values for both Parentwhosmoke and Class.
    # 1,523 observations have values for both Parentwhosmoke and Allowance.
    # 1,519 observations have values for both Parentwhosmoke and Friendwhosmokes.
    # 1,501 observations have values for both Parentwhosmoke and Seenantismokingad.
    # 1,224 observations have values for both Parentwhosmoke and Seenprosmokingcontent.

    # rm (Response-Missing)

    # The rm matrix tracks cases where the first variable has a value, but the second variable is missing:

    # Row 1 (Age):

    # 5 observations have values for Age but are missing for Sex.
    # 27 observations have values for Age but are missing for Class.
    # 4 observations have values for Age but are missing for Allowance.
    # 3 observations have values for Age but are missing for Friendwhosmokes.
    # 24 observations have values for Age but are missing for Seenprosmokingcontent.
    # 24 observations have values for Age but are missing for Seenantismokingad.
    # 2 observations have values for Age but are missing for Parentwhosmoke.

    # Row 2 (Sex):
      
    # 4 observations have values for Sex but are missing for Allowance.
    # 3 observations have values for Sex but are missing for Friendwhosmokes.
    # 24 observations have values for Sex but are missing for Seenprosmokingcontent.
    # 24 observations have values for Sex but are missing for Seenantismokingad.
    # 2 observations have values for Sex but are missing for Parentwhosmoke.

    # Row 3 (Parentwhosmoke):
     
    # 4 observations have values for Parentwhosmoke but are missing for Class.
    # 3 observations have values for Parentwhosmoke but are missing for Friendwhosmokes.
    # 24 observations have values for Parentwhosmoke but are missing for Seenprosmokingcontent.
    # 2 observations have values for Parentwhosmoke but are missing for Seenantismokingad.

    # mr (Missing-Response)

    # The mr matrix captures cases where the first variable is missing but the second variable has a value:

    # Row 1 (Age):

    # 5 observations are missing values for Age but have responses for Sex.
    # 27 observations are missing values for Age but have responses for Class.
    # 4 observations are missing values for Age but have responses for Allowance.
    # 3 observations are missing values for Age but have responses for Friendwhosmokes.
    # 24 observations are missing values for Age but have responses for Seenprosmokingcontent.
    # 24 observations are missing values for Age but have responses for Seenantismokingad.
    # 2 observations are missing values for Age but have responses for Parentwhosmoke.

    # Row 2 (Sex):
      
    # 5 observations are missing for Sex but have responses for Allowance.
    # 3 observations are missing for Sex but have responses for Friendwhosmokes.
    # 24 observations are missing for Sex but have responses for Seenprosmokingcontent.
    # 24 observations are missing for Sex but have responses for Seenantismokingad.
    # 2 observations are missing for Sex but have responses for Parentwhosmoke.

    # Row 3 (Parentwhosmoke):
      
    # 4 observations are missing for Parentwhosmoke but have responses for Class.
    # 3 observations are missing for Parentwhosmoke but have responses for Friendwhosmokes.
    # 24 observations are missing for Parentwhosmoke but have responses for Seenprosmokingcontent.
    # 2 observations are missing for Parentwhosmoke but have responses for Seenantismokingad.

    # mm (Missing-Missing)

    # The mm matrix shows cases where both variables are missing:

    # Row 1 (Age):

    # 2 observations are missing for both Age and Parentwhosmoke.
    # No observations are missing both Age and other variables.

    # Row 2 (Sex):

    # 3 observations are missing both Sex and Friendwhosmokes.
    # 4 observations are missing both Class and Allowance.
    # 24 observations are missing both Seenprosmokingcontent and Seenantismokingad.

    # Row 3 (Parentwhosmoke):
      
    # 3 observations are missing both Parentwhosmoke and Friendwhosmokes.
    # 24 observations are missing both Parentwhosmoke and Seenprosmokingcontent.
    # 2 observations are missing both Parentwhosmoke and Seenantismokingad

    ```

#### 5c. Create margin plot (VIM package) to see how missing values on one variable relate to values on another variable. We will do this for cholesterol (chl) and bmi

We will create margin plots using the VIM package to explore how missing values on one variable relate to values on another variable. In this case, we’ll examine the relationships between Sex and Riskoftobaccouse1, and Sex and Riskoftobaccouse2.

\*\*\* Setting up the Plot Arguments

The first argument specifies the dataset, selecting all rows and the columns Sex and Riskoftobaccouse1 or Sex and Riskoftobaccouse2 for examination in the margin plot. The col argument defines the colors used in the plot: Blue: Observations with no missing data for both variables. Red: Observations with missing data on one of the variables. Orange: Observations missing data on both variables. cex controls the size of the points, cex.lab adjusts the axis label size, cex.numbers sets the size of the displayed counts, and pch defines the symbol for the points.

\*\*\* Interpretation of the Plots

\*\*\* Plot 1: Sex and Riskoftobaccouse1

Blue Dots: Represent cases where both Sex and Riskoftobaccouse1 have observed values. There are several blue dots along the horizontal and vertical scatterplot areas, indicating records with complete data for both variables.

Red Dots on Axes:

Red dots along the vertical axis indicate cases where Riskoftobaccouse1 is observed, but Sex is missing. Red dots along the horizontal axis represent cases where Sex is observed, but Riskoftobaccouse1 is missing. In this plot, there are five red dots on the vertical axis and three red dots on the horizontal axis, indicating partial missing data for these variables.

Orange Indicator (0): The orange "0" signifies that there are no records where both Sex and Riskoftobaccouse1 are missing simultaneously.

Red Numbers:

The red 5 on the bottom axis represents the total records missing Sex. The red 9 on the left axis shows the total records missing Riskoftobaccouse1.

Boxplots (Blue and Red):

Blue boxplots along each axis display the distribution of Sex and Riskoftobaccouse1 for cases with no missing data. Red boxplots show the distribution of each variable when the other variable is missing.

\*\*\* Plot 2: Sex and Riskoftobaccouse2

Blue Dots: Represent cases where both Sex and Riskoftobaccouse2 have observed values. Similar to the first plot, there are several blue dots indicating complete data for these variables.

Red Dots on Axes:

Red dots on the vertical axis show cases where Riskoftobaccouse2 is observed, but Sex is missing. Red dots on the horizontal axis indicate cases where Sex is observed, but Riskoftobaccouse2 is missing. This plot also has five red dots on the vertical axis and three red dots on the horizontal axis, similar to the first plot. Orange Indicator (0): The orange "0" signifies that there are no cases with both Sex and Riskoftobaccouse2 missing simultaneously.

Red Numbers:

The red 5 on the bottom axis represents the total records missing Sex. The red 9 on the left axis indicates the total records missing Riskoftobaccouse2.

Boxplots (Blue and Red):

The blue boxplots show the distribution of Sex and Riskoftobaccouse2 for cases with complete data. The red boxplots show the distribution of each variable when the other variable is missing.

```{r}

marginplot(Tobacco_data4 %>% dplyr::select(Sex, Riskoftobaccouse1), col=c("blue","red","orange"), cex=1, cex.lab=1, cex.numbers=0.7, pch=20)
marginplot(Tobacco_data4 %>% dplyr::select(Sex, Riskoftobaccouse2), col=c("blue","red","orange"), cex=1, cex.lab=1, cex.numbers=0.7, pch=20)
```

#### 5d. Look at the distribution of one variable according to missing non-missing status for another variable using pbox (VIM package)

Riskoftobaccouse1:

The pbox plot visualizes Riskoftobaccouse1 scores, categorized by missing and observed data in Sex, Class, and Allowance.

Observed vs. Missing in Sex

Insight: When data for Sex is missing, Riskoftobaccouse1 scores show greater variability. Implication: Records with missing Sex data are associated with a wider range of risk scores, suggesting missingness in Sex may influence or correlate with variability in tobacco use risk.

Observed vs. Missing in Class:

Insight: There is minimal difference in Riskoftobaccouse1 scores between observed and missing values in Class. Implication: Missing Class data does not significantly affect variability in Riskoftobaccouse1, indicating that the distribution is stable regardless of missingness.

Observed vs. Missing in Allowance:

Insight: Missing data in Allowance corresponds to a notable increase in the variability of Riskoftobaccouse1 scores. Implication: This pattern suggests a possible association between missing Allowance data and a broader range of tobacco use risk perceptions.

Riskoftobaccouse2:

The pbox plot for Riskoftobaccouse2 highlights how its scores vary based on the missing and observed status of Sex, Class, and Allowance.

Observed vs. Missing in Sex

Insight: Similar to Riskoftobaccouse1, missing Sex data is associated with higher variability in Riskoftobaccouse2 scores. Implication: Missingness in Sex data may reflect an underlying association with a diverse range of risk levels for future tobacco use.

Observed vs. Missing in Class:

Insight: As with Riskoftobaccouse1, there is little difference in Riskoftobaccouse2 scores between observed and missing values in Class. Implication: Missing Class data is unlikely to strongly influence variability in Riskoftobaccouse2, reinforcing the pattern seen with Riskoftobaccouse1.

Observed vs. Missing in Allowance:

Insight: Missing data in Allowance shows a broader distribution of Riskoftobaccouse2 scores. Implication: This finding mirrors that of Riskoftobaccouse1, where missing Allowance data corresponds to greater variability in risk, suggesting a connection between missingness and diverse tobacco use risk levels.

Visualization Highlights:

First Chart: The variability in Riskoftobaccouse2 scores for missing and observed values in Sex, Class, and Allowance is evident. Missing data in Sex and Allowance clearly correlates with higher variability in scores.

Second Chart: Box plots for Class illustrate a stable distribution of scores between observed and missing data, reinforcing the minimal influence of missing Class data on both risk measures.

```{r}

pbox(Tobacco_data4, pos=4) # 4 is the column index (the number of the column from left to right)

pbox(Tobacco_data4, pos=5) # 5 is the column index (the number of the column from left to right)
```

#### 5e. Imputing data with the mice function from the MICE package.

-   the first argument is the data frame
-   m = number of imputations
-   Maxit is the number of iterations to get the imputation model to converge.
-   The seed is needed so you get the same set of imputed data each time you run the code.

```{r}
# Impute all missing values in the dataset without specifying a formula
imp <- mice(Tobacco_data4, m = 10, maxit = 5, seed = 1000000)
imp
```

#### 5f. Let's look at the meaning of the output

-   Iter is the iteration number for the model that is predicting a value for each of the missing data points. The default is 5.
-   Imp is the imputation number. By default, you get 5 imputed values (1 per imputed dataframe) for each missing value.
-   mids are the imputation datasets

```{r}
class(imp)
```

#### 5g Diagnostics for imputation model: Are the imputed values plausible?

```{r}
# check Age
imp$imp$Age # imp$imp refers to the list that holds the dataframe with the imputed values for each variable (both called imp) (Age, Sex, Riskoftobaccouse1, Riskoftobaccouse2, Class, Friendwhosmokes, Seenantismokingad, Seenprosmokingcontent). To view this click on imp in your global environment

# check Sex
imp$imp$Sex

# check Riskoftobaccouse1
imp$imp$Riskoftobaccouse1

# check Riskoftobaccouse2
imp$imp$Riskoftobaccouse2

# check Class
imp$imp$Class

# check Parentwhosmoke
imp$imp$Parentwhosmoke

# check Seenantismokingad
imp$imp$Seenantismokingad

# check Seenprosmokingcontent
imp$imp$Seenprosmokingcontent

# check Allowance.
imp$imp$Allowance

# check Friendwhosmokes
imp$imp$Friendwhosmokes

# the rows contain the imputed values and the columns are the multiple imputations
```

#### 5h. Obtain the first complete dataset in a normal dataframe for review using the complete function from the mice package

```{r}
imp1 <- mice::complete(data=imp, action=1) # action gives the imputation number you want. In this case the first imputation
imp1

longimp <- mice::complete(data=imp, action="long") # To get all the imputations in one dataframe provide the action "long". Two columns are added: 1) .imp, integer, referring the imputation number, and 2) .id, integer, the id number in the original dataframe;

longimp
```

#### 5i. Let's look at the imputed to the non-imputed data to see how the distributions compare using the function stripplot that plots the values for the imputed data and complete data in "strips"

-   x is the mids object,
-   data specifies the formula to be plotted (variables on the y-axis by imputation number)
-   pch gives the symbol to use
-   jit = TRUE jitters overlapping points
-   You should see that the imputed data is randomly distributed among the non-imputed data (red is imputed, blue is not imputed)
-   If not, one reason may be an error in the model that was used to impute a specific variable

```{r}
stripplot(x = imp, data = Age + Sex + Class + Allowance + Friendwhosmokes + Seenantismokingad + Seenprosmokingcontent ~.imp, jit=TRUE,  pch=c(1,20),  xlab="Blue = Non-missing, Imputation number", layout = c(4,1)) 

```

### 6. Results

#### 6a. Chi-square test of independence

```{r}

# Risk of tobacco use 1:

# List of predictors
predictors <- c("Age", "Class", "Allowance", "Friendwhosmokes", "Parentwhosmoke", "Seenantismokingad", "Seenprosmokingcontent")

# Outcome variable 
outcome <- "Riskoftobaccouse1"

# Loop through each predictor and run a Chi-square test
for (predictor in predictors) {
  cat("\nChi-square test between", predictor, "and", outcome, ":\n")
  table_Tobacco_data4 <- table(Tobacco_data4[[predictor]], Tobacco_data4[[outcome]])  # Create a contingency table
  chi_test <- chisq.test(table_Tobacco_data4)                        # Run the Chi-square test
  print(chi_test)                                           # Print the results
}

# Risk of tobacco use 2:

# List of predictors
predictors <- c("Age", "Class", "Allowance", "Friendwhosmokes", "Parentwhosmoke", "Seenantismokingad", "Seenprosmokingcontent")

# Outcome variable 
outcome <- "Riskoftobaccouse2"

# Loop through each predictor and run a Chi-square test
for (predictor in predictors) {
  cat("\nChi-square test between", predictor, "and", outcome, ":\n")
  table_Tobacco_data4 <- table(Tobacco_data4[[predictor]], Tobacco_data4[[outcome]])  # Create a contingency table
  chi_test2 <- chisq.test(table_Tobacco_data4)                        # Run the Chi-square test
  print(chi_test2)                                           # Print the results
}

```

#### 6.b Assessing multicollinearity:

```{r}

library(car)

# Fit the logistic regression model for Riskoftobaccouse1
model <- glm(Riskoftobaccouse1 ~ Age + Friendwhosmokes + Parentwhosmoke,
             data = Tobacco_data4, family = binomial)

# Calculate VIF values
vif_values <- vif(model)

# Print VIF values
print(vif_values)

# Fit the logistic regression model for Riskoftobaccouse2
model1 <- glm(Riskoftobaccouse2 ~ Friendwhosmokes + Seenantismokingad ,
             data = Tobacco_data4, family = binomial)

# Calculate VIF values
vif_values1 <- vif(model1)

# Print VIF values
print(vif_values1)

```

#### 6c. Unadjusted Multinom regression for Riskoftobaccouse1 for dataset with missing values:

```{r}
# Load the broom package for logistic regression
library(broom)

# Fit the logistic regression model
model <- glm(Riskoftobaccouse1 ~ Sex, data = Tobacco_data4, family = binomial)

# Get the summary of the model
model_summary <- summary(model)

# View the summary
print(model_summary)

# Extract coefficients, odds ratios, and confidence intervals using tidy()
model_tidy <- tidy(model, conf.int = TRUE, exponentiate = TRUE)

# View the tidy results
print(model_tidy)
```

### 6d. Unadjusted Multinom regression for Riskoftobaccouse2 for dataset with missing values:

```{r}

# Fit the logistic regression model
model2 <- glm(Riskoftobaccouse2 ~ Sex, data = Tobacco_data4, family = binomial)

# Get the summary of the model
model_summary2 <- summary(model2)

# View the summary
print(model_summary2)

# Extract coefficients, odds ratios, and confidence intervals using tidy()
model_tidy2 <- tidy(model2, conf.int = TRUE, exponentiate = TRUE)

# View the tidy results
print(model_tidy2)
```

### 6e. Adjusted model Riskoftobaccouse1:

```{r}
# Without interraction terms:

model2 <- glm(Riskoftobaccouse1 ~ Sex + Age + Friendwhosmokes + Parentwhosmoke, data = Tobacco_data4, family = binomial) # Fit the logistic regression model

model2_tidy <- tidy(model2, conf.int = TRUE, exponentiate = TRUE) # Extract coefficients, exponentiate, and include confidence intervals

print(model2_tidy) # View the tidy results

# With interraction terms:

modelEM2 <- glm(Riskoftobaccouse1 ~ Sex*(Age + Friendwhosmokes + Parentwhosmoke), data = Tobacco_data4, family = binomial) # Fit the logistic regression model

modelEM2_tidy <- tidy(modelEM2, conf.int = TRUE, exponentiate = TRUE) # Extract coefficients, exponentiate, and include confidence intervals

print(modelEM2_tidy) # View the tidy results

# Test the hypothesis with the lrtest
lrtest(model2, modelEM2)
```

### 6f. Adjusted model Riskoftobaccouse2:

```{r}

# Without interraction terms:

model3 <- glm(Riskoftobaccouse2 ~ Sex + Friendwhosmokes + Seenantismokingad, data = Tobacco_data4, family = binomial) # Fit the logistic regression model

model3_tidy <- tidy(model3, conf.int = TRUE, exponentiate = TRUE) # Extract coefficients, exponentiate, and include confidence intervals

print(model3_tidy) # View the tidy results

# With interraction terms:

modelEM3 <- glm(Riskoftobaccouse2 ~ Sex *(Friendwhosmokes + Seenantismokingad), data = Tobacco_data4, family = binomial) # Fit the logistic regression model

modelEM3_tidy <- tidy(modelEM3, conf.int = TRUE, exponentiate = TRUE) # Extract coefficients, exponentiate, and include confidence intervals

print(modelEM3_tidy) # View the tidy results

# Test the hypothesis with the lrtest
lrtest(model3, modelEM3)

```

### 6g. Get regression coefficients for all models using the *with* function from the mice package. Recall there will be 10 sets of regression coefficients and 10 intercepts because there are 10 imputed datasets in imp. Pool(fit) \# pool regression coefficients and standard errors using pool function. All the statistics can be interpreted.

```{r}

## Outcome: #Riskoftobaccouse1

# Without interraction terms:

# Fit the multinomial model on each imputed dataset
fit_i <- with(imp, glm(Riskoftobaccouse1 ~ Sex + Age + Friendwhosmokes + Parentwhosmoke, data = Tobacco_data4, family = binomial))

pooled_results <- pool(fit_i) # Pool the results from the imputed models

pooled_summary <- summary(pooled_results) # Get a summary of the pooled results

# Manually calculate 95% confidence intervals and exponentiate to get odds ratios
pooled_summary$conf.low <- pooled_summary$estimate - 1.96 * pooled_summary$std.error
pooled_summary$conf.high <- pooled_summary$estimate + 1.96 * pooled_summary$std.error
pooled_summary$OR <- exp(pooled_summary$estimate)
pooled_summary$conf.low <- exp(pooled_summary$conf.low)
pooled_summary$conf.high <- exp(pooled_summary$conf.high)

final_summary <- pooled_summary[, c("term", "OR", "conf.low", "conf.high", "p.value")] # Create a final data frame with relevant columns for interpretation

print(final_summary) # View the final summary

library(openxlsx)
write.xlsx(final_summary, "Imputated Risk of Tobacco use 1.xlsx")

# With interaction term:

# Fit the multinomial model on each imputed dataset
fit_i_EM <- with(imp, glm(Riskoftobaccouse1 ~ Sex*(Age + Friendwhosmokes + Parentwhosmoke), data = Tobacco_data4, family = binomial))

pooled_EM_results <- pool(fit_i_EM) # Pool the results from the imputed models

pooled_EM_summary <- summary(pooled_EM_results) # Get a summary of the pooled results

# Manually calculate 95% confidence intervals and exponentiate to get odds ratios
pooled_EM_summary$conf.low <- pooled_EM_summary$estimate - 1.96 * pooled_EM_summary$std.error
pooled_EM_summary$conf.high <- pooled_EM_summary$estimate + 1.96 * pooled_EM_summary$std.error
pooled_EM_summary$OR <- exp(pooled_EM_summary$estimate)
pooled_EM_summary$conf.low <- exp(pooled_EM_summary$conf.low)
pooled_EM_summary$conf.high <- exp(pooled_EM_summary$conf.high)

final_EM_summary <- pooled_EM_summary[, c("term", "OR", "conf.low", "conf.high", "p.value")] # Create a final data frame with relevant columns for interpretation

print(final_EM_summary) # View the final summary

library(openxlsx)
write.xlsx(final_EM_summary, "Imputated Risk of Tobacco use 1Interaction terms.xlsx")

```

```{r}

## Outcome: #Riskoftobaccouse2

# With interaction terms:

# Fit the multinomial model on each imputed dataset
fit_i1 <- with(imp, glm(Riskoftobaccouse2 ~ Sex + Friendwhosmokes + Seenantismokingad, data = Tobacco_data4, family = binomial))

pooled_results1 <- pool(fit_i1) # Pool the results from the imputed models

pooled_summary1 <- summary(pooled_results1) # Get a summary of the pooled results

# Manually calculate 95% confidence intervals and exponentiate to get odds ratios
pooled_summary1$conf.low <- pooled_summary1$estimate - 1.96 * pooled_summary1$std.error
pooled_summary1$conf.high <- pooled_summary1$estimate + 1.96 * pooled_summary1$std.error
pooled_summary1$OR <- exp(pooled_summary1$estimate)
pooled_summary1$conf.low <- exp(pooled_summary1$conf.low)
pooled_summary1$conf.high <- exp(pooled_summary1$conf.high)

final_summary1 <- pooled_summary1[, c("term", "OR", "conf.low", "conf.high", "p.value")] # Create a final data frame with relevant columns for interpretation

print(final_summary1) # View the final summary

library(openxlsx)
write.xlsx(final_summary1, "Imputated Risk of Tobacco use 2.xlsx")

# Without interaction terms:

# Fit the multinomial model on each imputed dataset
fit_i1_EM <- with(imp, glm(Riskoftobaccouse2 ~ Sex*(Friendwhosmokes + Seenantismokingad), data = Tobacco_data4, family = binomial))

pooled_results1 <- pool(fit_i1_EM) # Pool the results from the imputed models

pooled_EM_summary1 <- summary(pooled_results1) # Get a summary of the pooled results

# Manually calculate 95% confidence intervals and exponentiate to get odds ratios
pooled_EM_summary1$conf.low <- pooled_EM_summary1$estimate - 1.96 * pooled_EM_summary1$std.error
pooled_EM_summary1$conf.high <- pooled_EM_summary1$estimate + 1.96 * pooled_EM_summary1$std.error
pooled_EM_summary1$OR <- exp(pooled_EM_summary1$estimate)
pooled_EM_summary1$conf.low <- exp(pooled_EM_summary1$conf.low)
pooled_EM_summary1$conf.high <- exp(pooled_EM_summary1$conf.high)

final_EM_summary1 <- pooled_EM_summary1[, c("term", "OR", "conf.low", "conf.high", "p.value")] # Create a final data frame with relevant columns for interpretation

print(final_EM_summary1) # View the final summary

library(openxlsx)
write.xlsx(final_EM_summary1, "Imputated Risk of Tobacco use 2Interaction terms.xlsx")

```

### 7. Generating table1

```{r}

# Create the tables without missing data (using the imputated dataset)

table1(~ Age + Class + Allowance + Friendwhosmokes + Parentwhosmoke + Seenantismokingad + Seenprosmokingcontent + Riskoftobaccouse1 + Riskoftobaccouse2 | Sex, data = imp1)

```

### 8. Graphs

```{r arrangingPlots, message=FALSE}

# install.packages("ggpubr")
library(ggpubr)

# Use this code to see how your variable(Sex) is coded in the imp1 dataset
unique(imp1$Sex)

# First, create your plots! If you want to have a single legend for every plot (ex: the colors are the same for all plots), then make sure your plots are coded accordingly. Then, ggarrange

# plot A - scatter plot
plotA <- ggplot(data = imp1) + 
  geom_bar(position = "dodge", aes(x = Age, fill = Sex)) +  # fill and dodge work together here
  scale_fill_manual(values = c("M" = "blue", "F" = "grey")) +  # custom colors for Sex
  labs(title = "Participant distribution by age and sex", x = "Age", y = "Count") +  # proper axis labels
  theme_minimal()  # minimal theme for clean look
plotA

# plot B - histogram
plotB <- ggplot(data = imp1) + 
  geom_bar(position = "dodge", aes(x = Riskoftobaccouse1, fill = Sex)) + 
  scale_fill_manual(values = c("M" = "blue", "F" = "pink")) +
  labs(title = "Risk of Tobacco Use 1 by Sex", x = "If one of your best friends offered you a tobacco product, would you use it?", y = "Count") +
  theme_minimal()
plotB

# plot C - box plot
plotC <- ggplot(data = imp1) + 
  geom_bar(position = "dodge", aes(x = Riskoftobaccouse2, fill = Sex)) + 
  scale_fill_manual(values = c("M" = "green", "F" = "black")) +
  labs(title = "Risk of Tobacco Use 2 by Sex", x = "At anytime during the next 12 months do you think you will use any form of tobacco?", y = "Count") +
  theme_minimal()
plotC

# Second, ggarrange
combined_plot <- ggarrange(plotA, plotB, plotC, nrow = 2, ncol = 2, 
          common.legend = FALSE, 
          labels = c("A", "B", "C"), legend = "bottom")
# print the combined plot
combined_plot
```
